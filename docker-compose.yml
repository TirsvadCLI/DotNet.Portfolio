services:
  # This helper service will run the build stage from Dockerfile and copy
  # the produced /artifacts out into the host-mounted ./artifacts folder. The
  # service runs to completion and the publish-stage will be configured to
  # wait for it to complete successfully before starting.

  build-stage:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
      args:
        CONFIGURATION: Release
    # This job only builds and produces artifacts under ./artifacts
    restart: "no"

  tests-stage:
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
      args:
        CONFIGURATION: Test
    depends_on:
      build-stage:
        condition: service_completed_successfully
    working_dir: /workspace
    volumes:
      - ./TestResults:/artifacts/TestResults
    environment:
      - DOTNET_RUNNING_IN_CONTAINER=true
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      #- DOTNET_PORTFOLIO_CONNECTIONSTRINGS__DEFAULTCONNECTION__DATASOURCE=host.docker.internal
      - ASPNETCORE_ENVIRONMENT=Development
      - DOCKER_DOTNET_TEST=true
    restart: "no"
    # The Dockerfile.tests CMD will restore (if needed) and run tests using the mounted workspace
    # Ensure host.docker.internal resolves to the host gateway for environments that require it
    extra_hosts:
      - "host.docker.internal:host-gateway"
    tty: true
    stdin_open: true

  # publish-stage:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     target: runtime
  #     args:
  #       CONFIGURATION: Release
  #   depends_on:
  #     tests-stage:
  #       condition: service_completed_successfully
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     - "5000:5000"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Production
  #     - ASPNETCORE_URLS=http://+:80
  #     - DataProtection__KeyPath=/app/keys
  #   restart: unless-stopped
  #   volumes:
  #     - ./keys:/app/keys

volumes:
  sqlite_data: {}

